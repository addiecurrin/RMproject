---
title: "Run analysis"
author: "Adelaide Currin, Jennah Gosciak"
date: "2022-11-05"
output: html_document
---

```{r, setup}
library(tidyverse)
library(rlang)
library(fs)
library(tidycensus)
library(lehdr)
library(sf)
library(readxl)
library(plm)
library(lmtest)
library(sandwich)
library(wfe)
data_dir <- "/Users/adelaide/Documents/Grad School/NYU/Fall 2022/Research Methods/Project"

date <- Sys.Date() %>% 
  str_replace_all("-", "_")
```

```{r}
# define outcomes and covariates
outcomes <- c("C000rac", 
              "C000wac",
              "CE01rac", "CE01wac", "CE02rac", "CE02wac", "CE03rac", "CEO3wac",
              "CR01rac", "CR01wac", "CR02rac", "CR02wac", "CRothrac", "CRothwac",
              "CT02rac", "CT02wac",
              "S000_same_tract", "S000_desig", "S000_elig")

log_outcomes <- str_c(outcomes, "_log")


```

```{r}

merged_oz <- readRDS("../analysis_file.RDS")

merged_oz %>% 
  group_by(year, DESIGNATED) %>% 
  summarize(n = n())


cov <- c("log_median_household_income", "total_housing", "percent_white", "percent_postsec", "percent_rent", "percent_hc_covered", "percent_poverty", "percent_suplemental_income", "percent_employed")

```

# Plots

```{r}
merged_oz %>% 
  group_by(year, treatment) %>% 
  summarize(C000rac_avg = mean(C000rac_rate, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation", title = "Average jobs (RAC) per capita") +
  scale_y_continuous(limits = c(0.35, 0.45))


merged_oz %>% 
  group_by(year, treatment) %>% 
  summarize(C000rac_avg = mean(C000rac_log, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")

merged_oz %>% 
  group_by(year, treatment) %>% 
  summarize(C000wac_avg = mean(C000wac_log, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000wac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")

merged_oz %>% 
  arrange(GEOID, year) %>% 
  group_by(GEOID) %>% 
  arrange(year, .by_group = TRUE) %>% 
  mutate(C000rac_pct_change = ((C000rac/dplyr::lag(C000rac) - 1) * 100)) %>% 
  group_by(treatment, year) %>% 
  summarize(C000rac_avg = mean(C000rac_pct_change, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")
```

```{r}
# same as above, but dropping small tracts
merged_oz %>% 
  filter(C000rac > 1000) %>% 
  group_by(year, treatment) %>% 
  summarize(C000rac_avg = mean(C000rac_rate, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation") +
  scale_y_continuous(limits = c(0.35, 0.45))


merged_oz %>% 
  filter(C000rac > 1000) %>% 
  group_by(year, treatment) %>% 
  summarize(C000rac_avg = mean(C000rac_log, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")

merged_oz %>% 
  filter(C000wac > 1000) %>% 
  group_by(year, treatment) %>% 
  summarize(C000wac_avg = mean(C000wac_log, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000wac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")

merged_oz %>% 
  filter(C000rac > 1000) %>% 
  arrange(GEOID, year) %>% 
  group_by(GEOID) %>% 
  arrange(year, .by_group = TRUE) %>% 
  mutate(C000rac_pct_change = ((C000rac/dplyr::lag(C000rac) - 1) * 100)) %>% 
  group_by(treatment, year) %>% 
  summarize(C000rac_avg = mean(C000rac_pct_change, na.rm = T)) %>% 
  ggplot(aes(x = year, y = C000rac_avg)) +
  geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
  theme_classic() +
  labs(color = "Designation")
```

```{r}
# functions for each model
pooled_ols <- function(outcome, data, covariates) {
  return(lm(paste0(outcome, " ~ treatment:year + year + treatment +  ", str_c(covariates, collapse = "+")),
               data = data))
}
```


```{r}
generate_model_output <- function(fit_model, outcome, treat_var, model_type, data, print) {
  sum_fit_plm <- summary(fit_model)
  coef_names <- sum_fit_plm$coefficients[, 1] %>% 
      names()
  coef_vals <- coeftest(fit_model, vcov = vcovCL,
                                    type = "HC1",
                                    cluster = data$GEOID)
  
  if (print == TRUE) {
      sum_fit_plm %>% 
      print() 
    
    coef_vals %>% 
      print()
  }
  
  coef_pos <- which(treat_var == coef_names)
  
  coef <- round(sum_fit_plm$coefficients[coef_pos, 1], 3)
  se <- round(coef_vals[coef_pos, 2], 3)
  pval <- round(coef_vals[coef_pos, 4], 4)
  coef_ast <- case_when(pval < 0.01 ~ paste0(coef, "***"),
                        pval < 0.05 ~ paste0(coef, "**"),
                        pval < 0.1 ~ paste0(coef, "*"))
  
  return(data.frame("outcome" = outcome,
               "treatment_post" = sum_fit_plm$coefficients[coef_pos, 1],
               "coef_asterisk" = coef_ast,
               "se" = se,
               "pval" = pval,
               "rsq" = round(sum_fit_plm$r.squared[[1]], 3),
               "model_type" = model_type))
}

run_model_outcome <- function(outcome, models, data, covariates=cov, print=TRUE) {
  covariates <- str_c(covariates, collapse = " + ")
  print(str_c("Running model for ", outcome))
  results <- data.frame()
  
  if ("did" %in% models) {
    fit_did <- pooled_ols(outcome, data, covariates)
    results <- bind_rows(results, generate_model_output(fit_did, outcome,
                                                        "treatment", "did", data, print=print)) 
  }
 
  return(results)
}

models <- c("did")
run_model_outcome("S000_same_tract", models, data = merged_oz %>% 
                    filter(post == 0),
                  print=T)
```
```{r}
results <- map_dfr(c(log_outcomes), ~run_model_outcome(., models=models, 
                                                                 data = merged_oz %>% 
                                                                   filter(post == 0), print=T))
results
```

```{r}
ols_balance <- function(outcome, data) {
  return(lm(paste0(outcome, " ~ treatment"),
               data = data))
}

run_balance_tests <- function(outcome, data, print=TRUE) {
  print(str_c("Running model for ", outcome))
  results <- data.frame()
  
  if ("did" %in% models) {
    fit_did <- ols_balance(outcome, data)
    results <- bind_rows(results, generate_model_output(fit_did, outcome,
                                                        "treatment", "did", data, print=print)) 
  }


}

# balance test
balance_tests <- map_dfr(c(cov), ~run_balance_tests(., merged_oz %>% 
                                                                                 filter(year == 2017)))
balance_tests
```





