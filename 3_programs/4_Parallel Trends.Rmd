---
title: "Run analysis"
author: "Adelaide Currin, Jennah Gosciak"
date: "2022-11-05"
output: html_document
---

```{r, setup}
library(tidyverse)
library(rlang)
library(fs)
library(tidycensus)
library(lehdr)
library(sf)
library(readxl)
library(plm)
library(lmtest)
library(sandwich)
library(wfe)
library(did)
library(wesanderson)

data_dir <- "/Users/adelaide/Documents/GitHub/RMproject"

date <- Sys.Date() %>% 
  str_replace_all("-", "_")
```

```{r}
# define outcomes and covariates
outcomes <- c("C000rac", 
              "C000wac",
              "CE01rac", "CE01wac", "CE02rac", "CE02wac", "CE03rac", "CE03wac",
              "CR01rac", "CR01wac", "CR02rac", "CR02wac", "CRothrac", "CRothwac",
              "CT02rac", "CT02wac",
              "S000_same_tract", "S000_desig", "S000_elig")

log_outcomes <- str_c(outcomes, "_log")
pct_outcomes <- str_c(outcomes, "_pctchange")


```

```{r}
merged_oz <- readRDS("../2_output/analysis_file.RDS")  %>% 
  mutate(year_fact2014 = if_else(year == 2014, 1, 0),
           year_fact2015 = if_else(year == 2015, 1, 0),
           year_fact2016 = if_else(year == 2016, 1, 0),
           year_fact2017 = if_else(year == 2017, 1, 0),
           year_fact2018 = if_else(year == 2018, 1, 0),
           year_fact2019 = if_else(year == 2019, 1, 0))

merged_oz %>% 
  group_by(year, DESIGNATED) %>% 
  summarize(n = n())


cov <- c("log_median_household_income", "total_housing", "percent_white", "percent_postsec", "percent_rent", "percent_hc_covered", "percent_poverty", "percent_suplemental_income", "percent_employed", "dec_score", "SE_Flag", "vacancyrate", "pctunder18", "pctover64")

#only top commuting areas

topcommutezones <- merged_oz %>% 
  filter(`Our CBSA`==1)
```

# Plots

```{r}
generate_parallel_trends_plot <- function(df, type, outcome_type, df_type="commute",
                                          filter_outcomes=NULL, filter_outcomes_lab=NULL) {
  if (type == "log") {
    outcomes_list <- log_outcomes
  } else {
    outcomes_list <- pct_outcomes
  }
  
  if (outcome_type == "rac") {
    outcomes_list <- outcomes_list[str_detect(outcomes_list, "rac_")]
  } else if (outcome_type == "wac") {
    outcomes_list <- outcomes_list[str_detect(outcomes_list, "wac")]
  } else {
    outcomes_list <- outcomes_list[str_detect(outcomes_list, "same") |
                                     str_detect(outcomes_list, "elig") |
                                     str_detect(outcomes_list, "desig")]
  }
  
  if (!is.null(filter_outcomes)) {
    outcomes_list <- filter_outcomes
  }
  
  df_pivot <- df %>% 
    rename_at(outcomes_list, ~names(outcomes_list)) %>% 
    pivot_longer(names(outcomes_list), names_to = "outcomes", values_to = "employment") %>% 
    filter(year > 2014) %>% 
    group_by(year, treatment, outcomes) %>% 
    mutate(employment = if_else(employment == Inf, 0, employment)) %>% 
    summarize(employment = mean(employment, na.rm = T))
  
  plot <- df_pivot %>% 
      ggplot(aes(x = year, y = employment)) +
      geom_line(aes(color=if_else(treatment == 1, "Selected", "Eligible"))) +
      #geom_smooth(aes(color=if_else(treatment == 1, "Selected", "Eligible")),
      #            method=lm) +
      theme_classic() +
      labs(color = "Designation",
           y = "Growth (percentage points)",
           x = "Year") +
      facet_wrap(~outcomes, nrow=1, scales = "free") +
    scale_color_manual(values= wes_palette("Moonrise2", n = 2))
  
  plot %>%
    print()
  
  ggsave(paste0("../2_output/", outcome_type, "_", type, "_",
  df_type, filter_outcomes_lab, "_parallel_trends.png"),
         width = 11)
}
```

```{r}
vars_g1 <- c("Total employment\n(Residence Area Characteristics)" =
               "C000rac_pctchange",
             "Total employment\n(Workplace Area Characteristics)" = "C000wac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "rac", "commute", vars_g1, "total")

vars_g2 <- c("Jobs with earnings\n$1250/month or less" =
               "CE01rac_pctchange",
             "Jobs with earnings\n$1251/month to $3333/month" = "CE02rac_pctchange",
             "Jobs with earnings\ngreater than $3333/month" = "CE03rac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "rac", "commute", vars_g2, "wage")

vars_g3 <- c("Jobs with earnings\n$1250/month or less" =
               "CE01wac_pctchange",
             "Jobs with earnings\n$1251/month to $3333/month" = "CE02wac_pctchange",
             "Jobs with earnings\ngreater than $3333/month" = "CE03wac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "wac", "commute", vars_g3, "wage")

vars_g4 <- c("Jobs for workers who are white" =
               "CR01rac_pctchange",
             "Jobs for workers who are Black" = "CR02rac_pctchange",
             "Jobs for workers of other races" = "CRothrac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "rac", "commute", vars_g4, "race")

vars_g5 <- c("Jobs for workers who are white" =
               "CR01wac_pctchange",
             "Jobs for workers who are Black" = "CR02wac_pctchange",
             "Jobs for workers of other races" = "CRothwac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "wac", "commute", vars_g5, "race")

vars_g6 <- c("Jobs for workers who are Hispanic or Latino\n(Residence Area Characteristics)" =
               "CT02rac_pctchange",
             "Jobs for workers who are Hispanic or Latino\n(Workplace Area Characteristics)" = "CT02wac_pctchange")
generate_parallel_trends_plot(df = topcommutezones, "pct", "rac", "commute", vars_g6, "eth")

vars_g7 <- c("Live and work in the same tract" =
               "S000_same_tract_pctchange",
             "Work in a designated OZ tract" = "S000_desig_pctchange",
             "Work in an eligible OZ tract" = "S000_elig_pctchange")
  
generate_parallel_trends_plot(df = topcommutezones, "pct", "od", "commute", vars_g7, "od")
```

```{r}
# functions for each model
pooled_ols <- function(outcome, data, covariates) {
  
  return(lm(paste0(outcome, " ~ treatment:year + year + treatment +  ", str_c(covariates, collapse = "+")),
               data = data))
}
```


```{r}
generate_model_output <- function(fit_model, outcome, treat_var, model_type, data, print) {
  sum_fit_plm <- summary(fit_model)
  coef_names <- sum_fit_plm$coefficients[, 1] %>% 
      names()
  coef_vals <- coeftest(fit_model, vcov = vcovCL,
                                    type = "HC1",
                                    cluster = data$GEOID)
  
  if (print == TRUE) {
      sum_fit_plm %>% 
      print() 
    
    coef_vals %>% 
      print()
  }
  
  coef_pos <- which(treat_var == coef_names)
  
  coef <- round(sum_fit_plm$coefficients[coef_pos, 1], 3)
  se <- round(coef_vals[coef_pos, 2], 3)
  pval <- round(coef_vals[coef_pos, 4], 4)
  coef_ast <- case_when(pval < 0.01 ~ paste0(coef, "***"),
                        pval < 0.05 ~ paste0(coef, "**"),
                        pval < 0.1 ~ paste0(coef, "*"))
  
  return(data.frame("outcome" = outcome,
               "treatment_post" = sum_fit_plm$coefficients[coef_pos, 1],
               "coef_asterisk" = coef_ast,
               "se" = se,
               "pval" = pval,
               "rsq" = round(sum_fit_plm$r.squared[[1]], 3),
               "model_type" = model_type))
}

run_model_outcome <- function(outcome, models, data, covariates=cov, print=TRUE) {
  covariates <- str_c(covariates, collapse = " + ")
  print(str_c("Running model for ", outcome))
  results <- data.frame()
  
  if ("did" %in% models) {
    fit_did <- pooled_ols(outcome, data, covariates)
    results <- bind_rows(results, generate_model_output(fit_did, outcome,
                                                        "treatment:year", "did", data, print=print)) 
  }
 
  return(results)
}

models <- c("did")
run_model_outcome("C000rac_pctchange", models, data = merged_oz, print=T)
```

```{r}
resultspctcommuting <- map_dfr(pct_outcomes, ~run_model_outcome(., models=models, 
                                                                 data = topcommutezones %>% 
                                                                 filter(year > 2014), print=F))
resultspctcommuting
```


```{r}
ols_balance <- function(outcome, data) {
  return(lm(paste0(outcome, " ~ treatment"),
               data = data))
}

run_balance_tests <- function(outcome, data, print=TRUE) {
  print(str_c("Running model for ", outcome))
  results <- data.frame()
  
  if ("did" %in% models) {
    fit_did <- ols_balance(outcome, data)
    results <- bind_rows(results, generate_model_output(fit_did, outcome,
                                                        "treatment", "did", data, print=print)) 
  }


}

# balance test
balance_tests <- map_dfr(c(cov), ~run_balance_tests(., merged_oz %>%
                                                      filter(year == 2017)))
balance_tests

balance_tests_commuting <- map_dfr(c(cov), ~run_balance_tests(., topcommutezones %>%
                                                      filter(year == 2017)))
balance_tests_commuting

balance_tests_matched <- map_dfr(c(cov), ~run_balance_tests(., matched_data %>%
                                                      filter(year == 2017)))
balance_tests_matched
```

```{r}
# event study plots
event_model <- function(outcome, data, covariates) {
  form <- paste0(outcome, " ~ treatment:year_fact2016 + treatment:year_fact2017 + ",
  "treatment:year_fact2018 + treatment:year_fact2019 + ",
                    "year_fact2016 + year_fact2017 + year_fact2018 + year_fact2019 + post + treatment")
  
  if (covariates==TRUE) {
    form <- paste0(form, "+", str_c(cov, collapse="+"))
  }
  
  mod <- plm(form, 
               data = data, 
               index = c("GEOID"), 
               model = "within", 
               effect = "individual")
  
  return(mod)
}

generate_event_df <- function(outcome, data, covariates = FALSE) {
  mod <- event_model(outcome, data, covariates)

coef_vals <- coeftest(mod, vcovHC(mod, type = 'HC3', cluster = 'group'))
coef_vals %>% 
  print()

coef_vals[,] %>% 
  as_tibble(rownames="outcomes") %>% 
  mutate(estimate_ci_high = Estimate + (1.96*`Std. Error`),
         estimate_ci_low = Estimate - (1.96*`Std. Error`)) %>% 
  filter(str_detect(outcomes, "treatment")) %>% 
  mutate(year = as.numeric(str_replace_all(outcomes, "treatment:year_fact", "")),
         outcome = outcome,
         covariates = covariates) %>% 
  select(estimate = Estimate, estimate_ci_high, estimate_ci_low, year, outcome, covariates)
}

# generate event study plots using matched data
event_df <- bind_rows(map_dfr("C000wac_pctchange", ~generate_event_df(., merged_oz, covariates = F)))
event_df

generate_event_plot(event_df, "wac_", "matched")
```


```{r}
generate_event_plot <- function(df, type, data_type) {
  plot <- df %>% 
    filter(str_detect(outcome, type)) %>% 
    mutate(type = if_else(covariates == TRUE, "cov", "no cov")) %>% 
    ggplot() +
    geom_errorbar(aes(year, ymin = estimate_ci_low, ymax = estimate_ci_high, color = type),
                  position = "dodge") +
    geom_hline(aes(yintercept = 0)) +
    theme_classic() +
    facet_wrap(~outcome, ncol=1, scales = "free") +
    labs(y = "Pre-trend test coefficients (base year 2017)")
  
  plot %>% 
    print()

  ggsave(paste0("../2_output/", data_type, "_", type, "event_study.png"),
         height = 15)
}


generate_event_plot(event_df, "wac_", "matched")
#generate_event_plot(event_df, "S000_", "matched")
```

```{r}
# event study using did package
formula <- att_gt(yname = "C000wac_pctchange", tname = "year", idname = "GEOID",
                  xformla = ~1,
                  gname = "first.treat",
                  data = merged_oz %>% 
                    filter(year > 2014) %>% 
                    mutate(GEOID = as.numeric(GEOID),
                           first.treat = if_else(treatment == 1, 2018, 0)),
                           control_group = "nevertreated",
                  panel=T,
              est_method = "reg")

summary(formula)
ggdid(formula)
```






